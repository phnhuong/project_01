# 11. Maintenance & Operation Guide

This guide provides instructions for the long-term maintenance, operation, and contribution to the Student Management System backend.

---

## 1. System Overview

The backend is built with **Node.js (Express)**, **Prisma (ORM)**, and **PostgreSQL**. It follows a standard Layered Architecture:
- **Routes**: Define endpoints and apply validation/auth middleware.
- **Controllers**: Handle request logic, implement safety checks ('Find-Then-Act'), and send responses.
- **Services**: Contain business logic and database interactions.
- **Middleware**: Global logic for auth, validation, and error handling.

---

## 2. Standard Development Patterns

To maintain consistency and stability, follow these patterns when adding new features.

### 2.1 The 'Find-Then-Act' Pattern
Always verify the existence of a resource before attempting to update or delete it. This ensures clean `404 Not Found` responses instead of internal database errors.

```typescript
// Good Pattern in Controller
const existing = await myService.getById(id);
if (!existing) {
    throw new ApiError(404, 'Resource not found');
}
await myService.delete(id);
```

### 2.2 Using `ApiError`
Use the custom `ApiError` class for all operational errors. The global `errorMiddleware` will automatically format these into standardized JSON responses.

```typescript
import { ApiError } from '../utils/ApiError';

throw new ApiError(400, 'Invalid input data');
throw new ApiError(409, 'Record already exists');
```

### 2.3 Async Error Handling
Wrap all controller methods with the `asyncHandler` utility. This eliminates the need for `try-catch` blocks and ensures all errors are passed to the global handler.

```typescript
export const myControllerMethod = asyncHandler(async (req, res) => {
    // Logic here...
});
```

---

## 3. Troubleshooting & Logs

### 3.1 Console Logs
In development, the `errorMiddleware` logs error details to the console:
`[API Error 404] Resource not found`

### 3.2 Common Status Codes
- **400 (Bad Request)**: Validation failures or logic violations.
- **401 (Unauthorized)**: Missing or invalid JWT token.
- **403 (Forbidden)**: Role-based access denied.
- **404 (Not Found)**: Resource does not exist.
- **409 (Conflict)**: Uniqueness constraint violation (e.g., duplicate email).
- **500 (Internal Error)**: Unexpected crashes (check console/logs).

---

## 4. Testing Procedures

The project includes a comprehensive test suite (currently 115 tests).

### 4.1 Running Tests
```bash
cd backend
npm test
```

### 4.2 Adding New Tests
- Place tests in `src/tests`.
- Use the helpers in `src/tests/helpers.ts` for authentication and database setup.
- **Important**: When adding new routes, ensure they are registered in the `createTestApp` helper in `helpers.ts`.

---

## 5. Database Maintenance

### 5.1 Migrations
When updating the schema (`prisma/schema.prisma`):
```bash
npx prisma migrate dev --name your_migration_name
```

### 5.2 Seeding
To reset the database with initial developer data:
```bash
npx prisma db seed
```

---

## 6. Deployment Recap
Refer to [10.DEPLOYMENT_GUIDE.md](./10.DEPLOYMENT_GUIDE.md) for full server setup.
- **Process Manager**: PM2 is used to keep the backend running.
- **Reverse Proxy**: Nginx handles SSL and routes traffic to the Node.js process (Port 3000).
