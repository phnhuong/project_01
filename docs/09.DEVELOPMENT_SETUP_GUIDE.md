# Development Setup Guide - Há»‡ Thá»‘ng Quáº£n LÃ½ Há»c Sinh

---

## ThÃ´ng Tin TÃ i Liá»‡u

**Dá»± Ã¡n:** Há»‡ Thá»‘ng Quáº£n LÃ½ Há»c Sinh  
**MÃ´i trÆ°á»ng:** Development & Production  
**Há»‡ Ä‘iá»u hÃ nh:** Ubuntu 22.04 LTS  
**Deployment:** Direct Installation (PM2 + Nginx)  
**Server:** 192.168.147.3  
**Installation Path:** ~/qlhs_02  
**NgÃ y cáº­p nháº­t:** 09/02/2026  
**PhiÃªn báº£n:** 2.1

---

## Má»¥c Lá»¥c

1. [Overview](#1-overview)
2. [Server Information](#2-server-information)
3. [Prerequisites](#3-prerequisites)
4. [System Preparation](#4-system-preparation)
5. [PostgreSQL Setup](#5-postgresql-setup)
6. [Node.js Setup](#6-nodejs-setup)
7. [Nginx Setup](#7-nginx-setup)
8. [Project Setup](#8-project-setup)
9. [Backend Setup](#9-backend-setup)
10. [Frontend Setup](#10-frontend-setup)
11. [Database Initialization](#11-database-initialization)
12. [Running the Application](#12-running-the-application)
13. [PM2 Process Manager](#13-pm2-process-manager)
14. [SSL Configuration](#14-ssl-configuration)
15. [Troubleshooting](#15-troubleshooting)
16. [Maintenance Guide](#16-maintenance-guide)

---

## 1. Overview

### 1.1 Architecture

```
Ubuntu 22.04 LTS (192.168.147.3)
â”‚
â”œâ”€â”€ Nginx (Port 80/443)
â”‚   â”œâ”€â”€ Serves: Frontend static files
â”‚   â””â”€â”€ Proxy: Backend API requests â†’ localhost:3000
â”‚
â”œâ”€â”€ Backend (Port 3000)
â”‚   â”œâ”€â”€ Node.js 20.x
â”‚   â”œâ”€â”€ Express.js
â”‚   â”œâ”€â”€ Managed by PM2
â”‚   â””â”€â”€ Path: ~/qlhs_02/backend
â”‚
â”œâ”€â”€ Frontend
â”‚   â”œâ”€â”€ React (built to static files)
â”‚   â””â”€â”€ Path: ~/qlhs_02/frontend/dist
â”‚
â””â”€â”€ PostgreSQL (Port 5432)
    â”œâ”€â”€ Database: qlhs_db
    â”œâ”€â”€ User: admin123
    â””â”€â”€ System service
```

### 1.2 Development Environment
- **Localhost**: All services run on `localhost`.
- **Ports**:
  - Frontend: 5173
  - Backend: 3000
  - Postgres: 5432
  - Nginx: 80/443

---

## 2. Server Information

### 2.1 Production Server

```
IP Address: 192.168.147.3
OS: Ubuntu 22.04 LTS
Username: admin123
Password: admin123 (CHANGE IN PRODUCTION!)
Installation Directory: /home/admin123/qlhs_02
```

### 2.2 Security Note

âš ï¸ **CRITICAL:** Password `admin123` is for initial setup only.  
**Before going to production:**
1. Change system password: `passwd`
2. Change PostgreSQL password
3. Setup SSH key authentication
4. Disable password SSH login

---

## 3. Prerequisites

### 3.1 Required Software

| Software | Version | Purpose |
|----------|---------|---------|
| Ubuntu | 22.04 LTS | Operating System |
| Node.js | 20.x LTS | JavaScript runtime |
| npm | 10.x | Package manager |
| PostgreSQL | 16.x | Database |
| Nginx | Latest | Web server & reverse proxy |
| PM2 | Latest | Process manager |
| Git | Latest | Version control |

### 3.2 System Requirements

**Minimum:**
- CPU: 2 cores
- RAM: 4 GB
- Storage: 20 GB
- Network: 10 Mbps

**Recommended:**
- CPU: 4 cores
- RAM: 8 GB
- Storage: 50 GB SSD
- Network: 100 Mbps

---

## 4. System Preparation

### 4.1 Connect to Server

```bash
# From your local machine
ssh admin123@192.168.147.3

# Enter password: admin123
```

### 4.2 Update System

```bash
# Update package lists
sudo apt update

# Upgrade installed packages
sudo apt upgrade -y

# Reboot if kernel updated
sudo reboot

# Reconnect after reboot
ssh admin123@192.168.147.3
```

### 4.3 Install Essential Packages

```bash
# Install build essentials and tools
sudo apt install -y \
    build-essential \
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    ufw \
    software-properties-common \
    apt-transport-https \
    ca-certificates
```

### 4.4 Configure Firewall

```bash
# Enable UFW
sudo ufw enable

# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP and HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Check status
sudo ufw status verbose
```

**Expected output:**
```
Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
80/tcp                     ALLOW       Anywhere
443/tcp                    ALLOW       Anywhere
```

---

## 5. PostgreSQL Setup

### 5.1 Install PostgreSQL 16

```bash
# Add PostgreSQL repository
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'

# Import repository signing key
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

# Update package lists
sudo apt update

# Install PostgreSQL 16
sudo apt install -y postgresql-16 postgresql-contrib-16

# Verify installation
psql --version
```

**Expected output:**
```
psql (PostgreSQL) 16.x
```

### 5.2 Start PostgreSQL Service

```bash
# Start PostgreSQL
sudo systemctl start postgresql

# Enable auto-start on boot
sudo systemctl enable postgresql

# Check status
sudo systemctl status postgresql
```

### 5.3 Configure PostgreSQL

```bash
# Switch to postgres user
sudo -i -u postgres

# Create database
createdb qlhs_db

# Create user (already exists: admin123, but set password)
psql -c "ALTER USER admin123 WITH PASSWORD 'admin123';"

# Grant privileges
psql -c "GRANT ALL PRIVILEGES ON DATABASE qlhs_db TO admin123;"

# Exit postgres user
exit
```

### 5.4 Configure PostgreSQL for Local Access

```bash
# Edit pg_hba.conf
sudo nano /etc/postgresql/16/main/pg_hba.conf
```

**Find this line:**
```
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
```

**Ensure it says `md5` (not `peer` or `ident`)**

**Save and exit (Ctrl+X, Y, Enter)**

```bash
# Restart PostgreSQL
sudo systemctl restart postgresql
```

### 5.5 Test Connection

```bash
# Connect to database
psql -h localhost -U admin123 -d qlhs_db

# Enter password: admin123

# If successful, you'll see:
# qlhs_db=>

# List databases
\l

# Exit
\q
```

---

## 6. Node.js Setup

### 6.1 Install Node.js 20.x LTS

```bash
# Add NodeSource repository
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -

# Install Node.js
sudo apt install -y nodejs

# Verify installation
node --version
npm --version
```

**Expected output:**
```
v20.x.x
10.x.x
```

### 6.2 Install Global Packages

```bash
# Install PM2 (process manager)
sudo npm install -g pm2

# Install Prisma CLI
sudo npm install -g prisma

# Verify
pm2 --version
prisma --version
```

---

## 7. Nginx Setup

### 7.1 Install Nginx

```bash
# Install Nginx
sudo apt install -y nginx

# Start Nginx
sudo systemctl start nginx

# Enable auto-start
sudo systemctl enable nginx

# Check status
sudo systemctl status nginx
```

### 7.2 Test Nginx

```bash
# Open browser and go to:
http://192.168.147.3

# You should see: "Welcome to nginx!" page
```

### 7.3 Configure Nginx (Will configure later)

**We'll configure Nginx after setting up the application**

---

## 8. Project Setup

### 8.1 Create Project Directory

```bash
# Navigate to home directory
cd ~

# Create project directory
mkdir -p qlhs_02
cd qlhs_02

# Create subdirectories
mkdir -p backend frontend logs uploads
```

### 8.2 Clone Repository (or create structure)

**Option 1: Clone from Git**

```bash
cd ~/qlhs_02

# Clone repository
git clone https://github.com/your-org/student-management.git .

# Or clone to temp then move
git clone https://github.com/your-org/student-management.git temp
mv temp/* .
mv temp/.* . 2>/dev/null
rm -rf temp
```

**Option 2: Create structure manually**

```bash
cd ~/qlhs_02

# Create backend structure
mkdir -p backend/src/{controllers,services,models,routes,middleware,utils}
mkdir -p backend/prisma/{migrations,seeds}
mkdir -p backend/tests/{unit,integration}

# Create frontend structure
mkdir -p frontend/src/{components,pages,services,hooks,utils,context}
mkdir -p frontend/public
```

---

## 9. Backend Setup

### 9.1 Backend Directory Structure

```bash
cd ~/qlhs_02/backend

# Verify structure
ls -la
```

**Expected:**
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ utils/
â”‚   â””â”€â”€ server.js
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ seeds/
â”œâ”€â”€ tests/
â”œâ”€â”€ package.json
â”œâ”€â”€ .env
â””â”€â”€ .env.example
```

### 9.2 Initialize Backend

```bash
cd ~/qlhs_02/backend

# Initialize npm (if not already done)
npm init -y

# Install dependencies
npm install express \
    @prisma/client \
    bcrypt \
    jsonwebtoken \
    joi \
    cors \
    helmet \
    express-rate-limit \
    dotenv \
    winston \
    winston-daily-rotate-file

# Install dev dependencies
npm install -D \
    nodemon \
    jest \
    supertest \
    eslint \
    prettier \
    prisma
```

### 9.3 Configure Environment Variables

```bash
cd ~/qlhs_02/backend

# Create .env file
nano .env
```

**Add:**

```env
# Server
NODE_ENV=production
PORT=3000
HOST=localhost

# Database
DATABASE_URL=postgresql://admin123:admin123@localhost:5432/qlhs_db

# JWT
JWT_SECRET=your-super-secret-jwt-key-min-32-chars-change-this-in-production
JWT_EXPIRE=7d

# CORS
CORS_ORIGIN=http://192.168.147.3

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_LOGIN_MAX=5

# File Upload
MAX_FILE_SIZE=5242880
UPLOAD_DIR=/home/admin123/qlhs_02/uploads

# Logging
LOG_LEVEL=info
LOG_DIR=/home/admin123/qlhs_02/logs

# Email (optional)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=
EMAIL_PASSWORD=
EMAIL_FROM=noreply@qlhs.local

# Frontend URL
FRONTEND_URL=http://192.168.147.3
```

**Save and exit (Ctrl+X, Y, Enter)**

**Generate strong JWT secret:**

```bash
# Generate random secret
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Copy output and update JWT_SECRET in .env
```

### 9.4 Update package.json Scripts

```bash
nano package.json
```

**Add scripts:**

```json
{
  "name": "qlhs-backend",
  "version": "1.0.0",
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js",
    "test": "jest",
    "test:standard": "npm test src/tests/grades.test.ts src/tests/subjects.test.ts src/tests/academic-years.test.ts src/tests/classes.test.ts src/tests/scores.test.ts",
    "lint": "eslint src/",
    "format": "prettier --write src/"
  }
}
```

---

## 10. Frontend Setup

### 10.1 Frontend Directory Structure

```bash
cd ~/qlhs_02/frontend

# Verify structure
ls -la
```

**Expected:**
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ context/
â”‚   â”œâ”€â”€ App.jsx
â”‚   â””â”€â”€ main.jsx
â”œâ”€â”€ public/
â”œâ”€â”€ package.json
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ .env
â””â”€â”€ .env.example
```

### 10.2 Initialize Frontend

```bash
cd ~/qlhs_02/frontend

# Initialize npm (if not already done)
npm init -y

# Install dependencies
npm install react react-dom \
    react-router-dom \
    axios \
    react-hook-form \
    recharts \
    lucide-react

# Install dev dependencies
npm install -D \
    @vitejs/plugin-react \
    vite \
    tailwindcss \
    postcss \
    autoprefixer \
    eslint \
    prettier
```

### 10.3 Configure Environment Variables

```bash
cd ~/qlhs_02/frontend

# Create .env file
nano .env
```

**Add:**

```env
# API Configuration
VITE_API_URL=http://192.168.147.3/api
VITE_API_TIMEOUT=10000

# Application
VITE_APP_NAME=Há»‡ Thá»‘ng Quáº£n LÃ½ Há»c Sinh
VITE_APP_VERSION=1.0.0
VITE_NODE_ENV=production
```

### 10.4 Configure Vite

```bash
nano vite.config.js
```

**Add:**

```javascript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    host: true
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    minify: 'terser'
  }
});
```

### 10.5 Configure Tailwind

```bash
# Initialize Tailwind
npx tailwindcss init -p
```

```bash
nano tailwind.config.js
```

**Update:**

```javascript
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    }
  },
  plugins: [],
}
```

---

## 11. Database Initialization

### 11.1 Create Prisma Schema

```bash
cd ~/qlhs_02/backend

# Initialize Prisma
npx prisma init
```

**This creates:**
- `prisma/schema.prisma`
- `.env` (if not exists)

### 11.2 Define Schema

```bash
nano prisma/schema.prisma
```

**Complete schema:** (Copy from DATABASE_SCHEMA.md)

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique @db.VarChar(50)
  password  String   @db.VarChar(255)
  fullName  String   @map("full_name") @db.VarChar(100)
  role      String   @db.VarChar(20)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  auditLogs      AuditLog[]
  passwordResets PasswordReset[]

  @@map("users")
}

model Student {
  id            String   @id @default(uuid())
  studentCode   String   @unique @map("student_code") @db.VarChar(10)
  fullName      String   @map("full_name") @db.VarChar(100)
  dateOfBirth   DateTime @map("date_of_birth") @db.Date
  gender        String   @db.VarChar(10)
  address       String?  @db.VarChar(255)
  phoneNumber   String?  @map("phone_number") @db.VarChar(15)
  email         String?  @db.VarChar(100)
  guardianName  String?  @map("guardian_name") @db.VarChar(100)
  guardianPhone String?  @map("guardian_phone") @db.VarChar(15)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  scores Score[]

  @@map("students")
  @@index([studentCode])
}

model Subject {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(10)
  name      String   @db.VarChar(100)
  credits   Int      @default(1)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  scores Score[]

  @@map("subjects")
  @@index([code])
}

model Score {
  id              String   @id @default(uuid())
  studentId       String   @map("student_id")
  subjectId       String   @map("subject_id")
  semester        Int
  schoolYear      String   @map("school_year") @db.VarChar(10)
  score15Min      Decimal? @map("score_15_min") @db.Decimal(5, 2)
  score45Min      Decimal? @map("score_45_min") @db.Decimal(5, 2)
  scoreMidterm    Decimal? @map("score_midterm") @db.Decimal(5, 2)
  scoreFinal      Decimal? @map("score_final") @db.Decimal(5, 2)
  averageScore    Decimal? @map("average_score") @db.Decimal(5, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  student      Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject      Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  scoreHistory ScoreHistory[]

  @@unique([studentId, subjectId, semester, schoolYear])
  @@map("scores")
  @@index([studentId])
  @@index([subjectId])
}

model ScoreHistory {
  id        String   @id @default(uuid())
  scoreId   String   @map("score_id")
  oldValue  String   @map("old_value") @db.Text
  newValue  String   @map("new_value") @db.Text
  changedBy String   @map("changed_by") @db.VarChar(50)
  changedAt DateTime @default(now()) @map("changed_at")

  score Score @relation(fields: [scoreId], references: [id], onDelete: Cascade)

  @@map("score_history")
  @@index([scoreId])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  action     String   @db.VarChar(50)
  tableName  String   @map("table_name") @db.VarChar(50)
  recordId   String?  @map("record_id")
  oldData    String?  @map("old_data") @db.Text
  newData    String?  @map("new_data") @db.Text
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
  @@index([userId])
  @@index([tableName])
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
  @@index([userId])
  @@index([token])
}
```

### 11.3 Run Migrations

```bash
cd ~/qlhs_02/backend

# Generate Prisma Client
npx prisma generate

# Create initial migration
npx prisma migrate dev --name init

# Check migration status
npx prisma migrate status
```

### 11.4 Seed Database

**Create seed file:**

```bash
nano prisma/seed.js
```

**Add:**

```javascript
const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcrypt');

const prisma = new PrismaClient();

async function main() {
  console.log('ðŸŒ± Seeding database...');

  // Create users
  const hashedPassword = await bcrypt.hash('password123', 10);
  
  const users = await Promise.all([
    prisma.user.create({
      data: {
        username: 'admin',
        password: hashedPassword,
        fullName: 'Administrator',
        role: 'admin',
      },
    }),
    prisma.user.create({
      data: {
        username: 'teacher01',
        password: hashedPassword,
        fullName: 'Nguyá»…n VÄƒn GiÃ¡o ViÃªn',
        role: 'teacher',
      },
    }),
    prisma.user.create({
      data: {
        username: 'teacher02',
        password: hashedPassword,
        fullName: 'Tráº§n Thá»‹ GiÃ¡o ViÃªn',
        role: 'teacher',
      },
    }),
  ]);

  console.log(`âœ… Created ${users.length} users`);

  // Create subjects
  const subjects = await Promise.all([
    prisma.subject.create({ data: { code: 'TOAN', name: 'ToÃ¡n', credits: 4 } }),
    prisma.subject.create({ data: { code: 'LY', name: 'Váº­t LÃ½', credits: 3 } }),
    prisma.subject.create({ data: { code: 'HOA', name: 'HÃ³a Há»c', credits: 3 } }),
    prisma.subject.create({ data: { code: 'SINH', name: 'Sinh Há»c', credits: 2 } }),
    prisma.subject.create({ data: { code: 'VAN', name: 'Ngá»¯ VÄƒn', credits: 4 } }),
    prisma.subject.create({ data: { code: 'ANH', name: 'Tiáº¿ng Anh', credits: 3 } }),
    prisma.subject.create({ data: { code: 'SU', name: 'Lá»‹ch Sá»­', credits: 2 } }),
    prisma.subject.create({ data: { code: 'DIA', name: 'Äá»‹a LÃ½', credits: 2 } }),
    prisma.subject.create({ data: { code: 'GDCD', name: 'GDCD', credits: 1 } }),
    prisma.subject.create({ data: { code: 'TD', name: 'Thá»ƒ Dá»¥c', credits: 2 } }),
    prisma.subject.create({ data: { code: 'TIN', name: 'Tin Há»c', credits: 2 } }),
  ]);

  console.log(`âœ… Created ${subjects.length} subjects`);

  // Create sample students
  const students = await Promise.all([
    prisma.student.create({
      data: {
        studentCode: 'HS001',
        fullName: 'Nguyá»…n VÄƒn A',
        dateOfBirth: new Date('2010-01-15'),
        gender: 'Nam',
        address: '123 Nguyá»…n Huá»‡, Q.1, TP.HCM',
        phoneNumber: '0901234567',
      },
    }),
    prisma.student.create({
      data: {
        studentCode: 'HS002',
        fullName: 'Tráº§n Thá»‹ B',
        dateOfBirth: new Date('2010-03-20'),
        gender: 'Ná»¯',
        address: '456 LÃª Lá»£i, Q.1, TP.HCM',
        phoneNumber: '0907654321',
      },
    }),
    prisma.student.create({
      data: {
        studentCode: 'HS003',
        fullName: 'LÃª VÄƒn C',
        dateOfBirth: new Date('2010-05-10'),
        gender: 'Nam',
        address: '789 Tráº§n HÆ°ng Äáº¡o, Q.5, TP.HCM',
      },
    }),
    prisma.student.create({
      data: {
        studentCode: 'HS004',
        fullName: 'Pháº¡m Thá»‹ D',
        dateOfBirth: new Date('2010-07-25'),
        gender: 'Ná»¯',
        address: '321 VÃµ VÄƒn Táº§n, Q.3, TP.HCM',
      },
    }),
    prisma.student.create({
      data: {
        studentCode: 'HS005',
        fullName: 'HoÃ ng VÄƒn E',
        dateOfBirth: new Date('2010-09-30'),
        gender: 'Nam',
        address: '654 Pasteur, Q.1, TP.HCM',
      },
    }),
  ]);

  console.log(`âœ… Created ${students.length} students`);

  console.log('âœ… Seeding complete');
}

main()
  .catch((e) => {
    console.error('âŒ Error seeding database:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

**Run seed:**

```bash
cd ~/qlhs_02/backend

# Run seed
node prisma/seed.js
```

### 11.5 Verify Database

```bash
# Connect to database
psql -h localhost -U admin123 -d qlhs_db

# List tables
\dt

# Count records
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM students;
SELECT COUNT(*) FROM subjects;

# Exit
\q
```

---

## 12. Running the Application

### 12.1 Test Backend

```bash
cd ~/qlhs_02/backend

# Run in development mode
npm run dev

# Or production mode
npm start
```

**Expected output:**
```
ðŸš€ Server running on http://localhost:3000
ðŸ“Š Database connected successfully
```

**Test API:**

```bash
# In another terminal
curl http://localhost:3000/health

# Expected: {"status":"ok"}
```

**Stop server (Ctrl+C)**

### 12.2 Build Frontend

```bash
cd ~/qlhs_02/frontend

# Install dependencies (if not done)
npm install

# Build for production
npm run build
```

**This creates:** `frontend/dist/` with static files

**Verify:**

```bash
ls -la dist/

# Should see:
# index.html
# assets/
```

---

## 13. PM2 Process Manager

### 13.1 Why PM2?

- âœ… Keep Node.js process running
- âœ… Auto-restart on crash
- âœ… Auto-start on server reboot
- âœ… Log management
- âœ… Load balancing (if needed)

### 13.2 Create PM2 Ecosystem File

```bash
cd ~/qlhs_02

# Create ecosystem file
nano ecosystem.config.js
```

**Add:**

```javascript
module.exports = {
  apps: [
    {
      name: 'qlhs-backend',
      cwd: '/home/admin123/qlhs_02/backend',
      script: 'src/server.js',
      instances: 1,
      exec_mode: 'fork',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      error_file: '/home/admin123/qlhs_02/logs/backend-error.log',
      out_file: '/home/admin123/qlhs_02/logs/backend-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      merge_logs: true,
      autorestart: true,
      max_restarts: 10,
      min_uptime: '10s',
    },
  ],
};
```

### 13.3 Start Application with PM2

```bash
cd ~/qlhs_02

# Start application
pm2 start ecosystem.config.js

# Check status
pm2 status

# View logs
pm2 logs qlhs-backend

# Stop logs (Ctrl+C)
```

### 13.4 Setup PM2 Auto-Start

```bash
# Generate startup script
pm2 startup

# Copy and run the command it outputs
# Example: sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u admin123 --hp /home/admin123

# Save current PM2 process list
pm2 save
```

### 13.5 PM2 Commands Reference

```bash
# Start
pm2 start ecosystem.config.js

# Stop
pm2 stop qlhs-backend

# Restart
pm2 restart qlhs-backend

# Reload (zero-downtime)
pm2 reload qlhs-backend

# Delete
pm2 delete qlhs-backend

# Status
pm2 status

# Logs
pm2 logs
pm2 logs qlhs-backend
pm2 logs qlhs-backend --lines 100

# Monitoring
pm2 monit
```

---

## 14. Nginx Configuration

### 14.1 Create Nginx Config

```bash
# Create config file
sudo nano /etc/nginx/sites-available/qlhs
```

**Add:**

```nginx
server {
    listen 80;
    server_name 192.168.147.3;

    # Client max body size (for file uploads)
    client_max_body_size 10M;

    # Logs
    access_log /home/admin123/qlhs_02/logs/nginx-access.log;
    error_log /home/admin123/qlhs_02/logs/nginx-error.log;

    # Frontend - Serve static files
    location / {
        root /home/admin123/qlhs_02/frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API - Reverse proxy
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 14.2 Enable Site

```bash
# Create symbolic link
sudo ln -s /etc/nginx/sites-available/qlhs /etc/nginx/sites-enabled/

# Remove default site
sudo rm /etc/nginx/sites-enabled/default

# Test configuration
sudo nginx -t
```

**Expected:**
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### 14.3 Restart Nginx

```bash
# Restart Nginx
sudo systemctl restart nginx

# Check status
sudo systemctl status nginx
```

### 14.4 Test Application

**Open browser:**

```
http://192.168.147.3
```

**You should see the Student Management System login page!**

**Default login:**
- Username: `teacher01`
- Password: `password123`

---

## 15. SSL Configuration (Optional for Production)

### 15.1 Install Certbot

```bash
# Install Certbot
sudo apt install -y certbot python3-certbot-nginx
```

### 15.2 Obtain SSL Certificate

**Note:** This requires a domain name. If using IP only, skip this section.

```bash
# Obtain certificate
sudo certbot --nginx -d yourdomain.com

# Follow prompts
```

### 15.3 Auto-Renewal

```bash
# Test renewal
sudo certbot renew --dry-run

# Certbot creates auto-renewal cron job automatically
```

---

## 16. Troubleshooting

### 16.1 Backend Won't Start

**Check logs:**

```bash
pm2 logs qlhs-backend

# Or
cat ~/qlhs_02/logs/backend-error.log
```

**Common issues:**

1. **Port 3000 already in use**
```bash
# Find process using port 3000
sudo lsof -i :3000

# Kill process
sudo kill -9 <PID>

# Restart PM2
pm2 restart qlhs-backend
```

2. **Database connection error**
```bash
# Check PostgreSQL is running
sudo systemctl status postgresql

# Test connection
psql -h localhost -U admin123 -d qlhs_db

# Check DATABASE_URL in .env
cat ~/qlhs_02/backend/.env | grep DATABASE_URL
```

3. **Missing dependencies**
```bash
cd ~/qlhs_02/backend
npm install
pm2 restart qlhs-backend
```

### 16.2 Frontend Not Loading

**Check Nginx:**

```bash
# Check Nginx status
sudo systemctl status nginx

# Check Nginx error logs
sudo tail -f /home/admin123/qlhs_02/logs/nginx-error.log

# Test Nginx config
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx
```

**Check frontend build:**

```bash
cd ~/qlhs_02/frontend

# Rebuild
npm run build

# Verify dist folder exists
ls -la dist/
```

**Check file permissions:**

```bash
# Give Nginx read access
chmod -R 755 ~/qlhs_02/frontend/dist
```

### 16.3 API Not Working

**Test backend directly:**

```bash
curl http://localhost:3000/api/health
```

**If works, check Nginx proxy:**

```bash
# Check Nginx config
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx
```

**Test through Nginx:**

```bash
curl http://192.168.147.3/api/health
```

### 16.4 Database Issues

**Check PostgreSQL:**

```bash
# Status
sudo systemctl status postgresql

# Restart
sudo systemctl restart postgresql

# Connect
psql -h localhost -U admin123 -d qlhs_db
```

**Reset database (CAUTION: Deletes all data!):**

```bash
cd ~/qlhs_02/backend

# Reset
npx prisma migrate reset

# Seed
node prisma/seed.js
```

### 16.5 Permission Issues

**Fix ownership:**

```bash
# Fix ownership
sudo chown -R admin123:admin123 ~/qlhs_02

# Fix permissions
chmod -R 755 ~/qlhs_02
```

---

## 17. Maintenance

### 17.1 View Application Logs

```bash
# PM2 logs
pm2 logs qlhs-backend

# Nginx logs
tail -f ~/qlhs_02/logs/nginx-access.log
tail -f ~/qlhs_02/logs/nginx-error.log

# Application logs
tail -f ~/qlhs_02/logs/backend-error.log
```

### 17.2 Update Application

```bash
# Pull latest code
cd ~/qlhs_02
git pull origin main

# Update backend
cd backend
npm install
npx prisma generate
npx prisma migrate deploy

# Update frontend
cd ../frontend
npm install
npm run build

# Restart services
pm2 restart qlhs-backend
sudo systemctl restart nginx
```

### 17.3 Backup Database

```bash
# Create backup
pg_dump -h localhost -U admin123 qlhs_db > ~/backups/qlhs_$(date +%Y%m%d).sql

# Compress
gzip ~/backups/qlhs_$(date +%Y%m%d).sql
```

### 17.4 Restore Database

```bash
# Restore from backup
psql -h localhost -U admin123 -d qlhs_db < ~/backups/qlhs_20260203.sql
```

---

## 18. Quick Reference

### 18.1 Essential Commands

```bash
# ===== PM2 =====
pm2 status                    # View status
pm2 restart qlhs-backend      # Restart app
pm2 logs qlhs-backend         # View logs
pm2 monit                     # Monitor

# ===== Nginx =====
sudo systemctl status nginx   # Check status
sudo systemctl restart nginx  # Restart
sudo nginx -t                 # Test config

# ===== PostgreSQL =====
sudo systemctl status postgresql  # Check status
psql -h localhost -U admin123 -d qlhs_db  # Connect

# ===== Application =====
cd ~/qlhs_02                  # Go to project
cd backend && npm run dev     # Run backend (dev)
cd frontend && npm run build  # Build frontend
```

### 18.2 Important Paths

```
Project:        /home/admin123/qlhs_02
Backend:        /home/admin123/qlhs_02/backend
Frontend:       /home/admin123/qlhs_02/frontend
Frontend Dist:  /home/admin123/qlhs_02/frontend/dist
Logs:           /home/admin123/qlhs_02/logs
Uploads:        /home/admin123/qlhs_02/uploads
Nginx Config:   /etc/nginx/sites-available/qlhs
```

### 18.3 Default Credentials

**System:**
- User: admin123
- Password: admin123 (CHANGE IN PRODUCTION!)

**Database:**
- Host: localhost
- Port: 5432
- Database: qlhs_db
- User: admin123
- Password: admin123

**Application:**
- Username: teacher01
- Password: password123

---

## 19. Next Steps

### 19.1 Security Hardening (Production)

1. **Change passwords**
```bash
# System password
passwd

# PostgreSQL password
psql -h localhost -U admin123 -d qlhs_db
ALTER USER admin123 WITH PASSWORD 'new-strong-password';
\q

# Update .env with new password
```

2. **Setup SSH key authentication**
3. **Configure firewall properly**
4. **Setup SSL certificate**
5. **Regular backups**

### 19.2 Monitoring Setup

1. Install monitoring tools
2. Setup alerting
3. Configure log rotation

### 19.3 Performance Optimization

1. Database indexes
2. Nginx caching
3. PM2 clustering (if needed)

---

## Congratulations! ðŸŽ‰

Your Student Management System is now running on Ubuntu 22.04!

**Access your application:**
```
http://192.168.147.3
```

**Default login:**
- Username: teacher01
- Password: password123

ðŸš€ **Ready to use!**
